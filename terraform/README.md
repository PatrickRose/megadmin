# Terraform Infrastructure

Azure infrastructure for megadmin, deployed to UK South.

## Prerequisites

- [Terraform](https://developer.hashicorp.com/terraform/install) >= 1.5
- [Azure CLI](https://learn.microsoft.com/en-us/cli/azure/install-azure-cli) logged in (`az login`)
- Correct subscription selected: `az account set --subscription your-subscription-id`

## First-time setup

### 1. Create the Terraform state backend

This only needs to be done once. It stores Terraform's state file in Azure.

```bash
az group create -n rg-megadmin-tfstate -l uksouth
az storage account create -n stmegadmintfstate -g rg-megadmin-tfstate -l uksouth
az storage container create -n tfstate --account-name stmegadmintfstate
```

If `az storage account create` fails with `SubscriptionNotFound`, you may need to
register the Storage provider first:

```bash
az provider register --namespace Microsoft.Storage
# Wait until registered:
az provider show -n Microsoft.Storage --query registrationState -o tsv
```

### 2. Create `terraform.tfvars`

Create `terraform/terraform.tfvars` (this file is gitignored):

```hcl
subscription_id = "your-subscription-id"

# SMTP (Mailgun)
smtp_username = "noreply@megagameadmin.co.uk"
smtp_password = "your-mailgun-smtp-password"
smtp_domain   = "megagameadmin.co.uk"
```

The Postgres password and Rails `SECRET_KEY_BASE` are auto-generated by Terraform
and stored in Azure Key Vault.

### 3. Initialise and apply Terraform

```bash
cd terraform
terraform init
terraform plan    # review what will be created
terraform apply   # create the resources
```

### 4. Set GitHub Actions secrets

After `terraform apply`, get the values needed for CI/CD:

```bash
terraform output azure_client_id
terraform output azure_tenant_id
terraform output azure_subscription_id
```

Add these as repository secrets in GitHub (Settings > Secrets and variables > Actions):

- `AZURE_CLIENT_ID`
- `AZURE_TENANT_ID`
- `AZURE_SUBSCRIPTION_ID`

### 5. Configure DNS

Point `megagameadmin.co.uk` to the Container App FQDN:

```bash
terraform output web_app_url
```

Create a CNAME record with your DNS provider pointing to the FQDN from the output
(without the `https://` prefix).

### 6. Deploy

The GitHub Actions workflow (`.github/workflows/deploy.yml`) deploys automatically
when CI passes on `main`. It can also be triggered manually from the Actions tab.

The workflow:
1. Builds the Docker image and pushes to Azure Container Registry
2. Runs database migrations via a Container App Job
3. Updates the web and worker containers
4. Runs a health check against `/up`

## Resources created

| Resource | Name | Notes |
|---|---|---|
| Resource Group | rg-megadmin-production | |
| PostgreSQL Flexible Server | psql-megadmin-production | B_Standard_B1ms, 32GB, private network only |
| Container App (web) | ca-megadmin-web | 0.25 vCPU, 0.5GB |
| Container App (worker) | ca-megadmin-worker | 0.25 vCPU, 0.5GB |
| Container App Job (migrate) | caj-megadmin-migrate | Manual trigger |
| Container Registry | acrmegadminproduction | Basic SKU |
| Storage Account | stmegadminproduction | Standard LRS, for Active Storage uploads |
| Key Vault | kv-megadmin-production | Postgres password, SECRET_KEY_BASE, storage key, SMTP password |
| Log Analytics Workspace | log-megadmin-production | 30-day retention |
| Virtual Network | vnet-megadmin-production | 2 subnets (container apps, postgres) |

## Useful commands

```bash
# Check current state
terraform plan

# Apply changes
terraform apply

# View outputs (e.g. for GitHub secrets)
terraform output

# View a specific secret from Key Vault
az keyvault secret show --vault-name kv-megadmin-production --name postgres-password --query value -o tsv

# Manually trigger a migration
az containerapp job start -n caj-megadmin-migrate -g rg-megadmin-production

# View web app logs
az containerapp logs show -n ca-megadmin-web -g rg-megadmin-production --follow
```
